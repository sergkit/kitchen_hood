# Управление  вытяжкой на кухне

Проект предназначен для автоматического  включения и выключения вытяжки на кухне.
Логика:
      * включить если разница температур между датчиками  выше  заданной  на DT_LIMIT+0.5 (dt>=DT_LIMIT+0.5 && !is_on)
      * включить если разница  между предыдущей и текущей температурой  >0.1  (t1-t_last>0.1 && !is_on)
      * выключить если  температура упала ниже запомненной  ранее температуры  включения (t1<tmin && is_on)
      * выключить если температура уменьшилась на 0,1 и уменьшение  два раза подряд (t_last-t1>0.1 && temp_down && is_on)
      * выключить, если два раза подряд  температура понижается
проблема  - корпус или сам вентилятор нагреваются при работе плиты, работающий вентилятор охлаждает датчик. 
t1 уменьшается, вентилятор выключается. Когда вентилятор отключается, корпус начинает греть датчик, температура  повышается, включается вентилятор. 


## HARDWARE
Требуется плата ESP8266, 2  датчика  DS18B20, Опционально можно использовать внешний  WatchDog  таймер, например TPL5010.
Подключение:
12 -> D6  DS18b20
13 -> D7  light
2  -> D4  int led
 
14 -> D5  Вентилятор
0  -> D3  в момент старта должны быть подтянуты к единичке    provision
15 -> D8  WDDonePin  в момент старта должен быть подтянут к нулю

Просто полезности:
4,5,12,13,14 - пины без всяких условностей.
0 и 2 - в момент старта должны быть подтянуты к единичке. Это ничуть не мешает использовать их, к примеру, для той же I2C шины, где заодно нужна подтяжка.
15 - в момент старта должен быть подтянут к нулю. Это более сложная ситуация. Чтобы не заморачиваться - можно использовать его в качестве выхода.
16 - выход с открытым коллектором. Лучше не использовать, резервируя до времен когда он понадобится для выхода из спящего режима.
1,3 - UART - лучше не трогать. Используется для программирования и общения с компом или другими устройствами. В Nodemcu он уже подключен к микросхеме интерфейса. лучше и оставить для этих целей, IMHO.

## SOFTWARE
Контроллер работает под управлением Mongoose OS.


## Дополнительно
Можно управлять  вытяжкой из приложения, отправляя  HTTP запросы  типа  curl 192.168.1.11/rpc/off_vent -d '{"minutes":1, "key": "HOOD_?????", "on_off": true}'
При старте, если не заданы настройки  WIFI, контроллер поднимает свою точку доступа. При подключении к ней  можно открыть страницу и задать  параметры подключения к wifi/

